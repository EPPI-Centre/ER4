<div class="col-12 p-1 mx-1 rounded border container border-info" style="min-width:650px; overflow:auto;">
    <div *ngIf="IsServiceBusy()" class="k-loading-image" style="position: fixed; top: 0%; height:100%; max-height:100%"></div>
    <div *ngIf="CurrentStep == 0">
        <div class="col-10 center rounded border border-info alert-info ">
            You can setup and review your screening settings in two ways: 
            <ol>
                <li>Via the guided steps wizard (preferred)</li>
                <li>By viewing progress and then editing all settings from there</li>
            </ol>
        </div>
        <div class="col-10 center rounded border border-success">
            <button class=" pt-1 m-1 btn btn-success" style="min-width:100px" [disabled]="!CanWrite()" (click)="NextStep()">
                Setup Wizard
            </button>
            <button class=" pt-1 m-1 btn btn-outline-primary" style="min-width:100px" (click)="GoToAllinOneStep()">
                View Progress and Status
            </button>
            <button class=" pt-1 m-1 btn btn-outline-dark " (click)="Cancel()" style="min-width:100px">
                Cancel
            </button>
        </div>
    </div>
    <!--This is the actual Wizard part-->
    <div *ngIf="CurrentStep > 0 && CurrentStep < 4">
        <div class="row my-1 mx-0 alert alert-success h5">
            Setup Screening - Step {{CurrentStep}}: {{CurrentStepName}}
        </div>
        <div class="col-12 rounded border border-info alert-info m-0 p-1 ">
            This wizard will help you setting up "random" and "priority" screening:<br />
            <ol class="pl-4 mb-0">
                <li [ngClass]="{'font-weight-bold' : CurrentStep==1}">
                    <div class="row m-0">
                        Screening tool and what to screen:
                        <div *ngIf="selectedCodeSetDropDown !== null" class="border font-weight-normal border-success rounded bg-light ml-1 px-1">
                            Tool: {{GetCodingToolName()}}
                            <span *ngIf="ScreenAllItems">
                                | All Items
                            </span>
                            <span *ngIf="!ScreenAllItems && DropdownWithWithoutSelectedCode != null">
                                | Items with this code: {{DropdownWithWithoutSelectedCode.name}}
                            </span>
                        </div>
                    </div>
                </li>
                <li [ngClass]="{'font-weight-bold' : CurrentStep==2}">
                    <div class="row m-0">
                        How to screen:
                        <div *ngIf="revInfo.screeningMode !=''" class="border font-weight-normal border-success rounded bg-light ml-1 px-1">
                            Mode: {{revInfo.screeningMode}}
                            <span *ngIf="selectedCodeSetDropDown != null && selectedCodeSetDropDown.codingIsFinal && revInfo.screeningNPeople == 0">
                                | One person per item
                            </span>
                            <span *ngIf="revInfo.screeningNPeople > 1">
                                | {{revInfo.screeningNPeople}} people per item
                            </span>
                        </div>
                    </div>
                </li>
                <li [ngClass]="{'font-weight-bold' : CurrentStep==3}">Automation options</li>
            </ol>
        </div>
        <div *ngIf="CurrentStep==1" class="">
            <div class="row my-1 mx-0">
                <div class="col-8">
                    <ng-container *ngTemplateOutlet="TemplateScreeningTool"></ng-container>
                </div>
                <div class="col-4 rounded border border-info alert-info small">
                    This is the tool you will use to screen your references. Note that <strong>priority screening</strong> (the "active learning" system) looks at title and abstract only,
                    so it might be some use for screening on Full-Text, but is specifically designed to assist screening on <strong>title and abstract</strong>.
                </div>
            </div>
            <div class="row my-1 mx-0" [ngClass]="{'DisabledStep' : !CanChangeWhatToScreen}">
                <div class="col-8">
                    <ng-container *ngTemplateOutlet="TemplateScreenWhat"></ng-container>
                </div>
                <div class="col-4 rounded border border-info alert-info small">
                    You can restrict screening to "All items with this code", or screen all items available in the review. Most frequently, you'll screen all items.
                </div>
            </div>
            <div class="row justify-content-center mx-0">
                <button (click)="PreviousStep()" class=" pt-1 m-1 btn btn-outline-dark " style="min-width:100px">
                    Previous
                </button>
                <button class=" pt-1 m-1 btn btn-success" style="min-width:100px" [disabled]="!CanGoToStep2()" (click)="NextStep()">
                    Next
                </button>
                <button class=" pt-1 m-1 btn btn-outline-dark " (click)="Cancel()" style="min-width:100px">
                    Cancel
                </button>
            </div>
        </div>


        <div *ngIf="CurrentStep==2" class="">
            <div class="row my-1 mx-0 " [ngClass]="{'DisabledStep' : !CanGoToStep2()}">
                <div class="col-7">
                    <ng-container *ngTemplateOutlet="TemplateScreeeningMode"></ng-container>
                </div>
                <div class="col-5 rounded border border-info alert-info small">
                    Use "Priority Screening" or randomise the order in which items are screened? <br />
                    Note that it is <strong>recommended</strong> to enable Priority Screening only after you have found a good number of both "Included" and "Excluded" items (this is called <em>Seeding</em>).<br />
                    Priority Screening will use a randomised list if it is not seeded and will switch to priority mode when a <em>minimal</em> amount of seeding data is available.<br />
                    Manual seeding is <strong>recommended</strong> because it allows the machine to learn from better data.
                    Thus, you may want to start by picking "random" and then change to "Priority" only after you have found a <strong>representative</strong> sample of "Included" items.
                    Proceeding in this way also allows to evaluate how many "Includes" you expect to find overall (useful to decide when to stop screening, if needed).
                </div>
            </div>

            <div *ngIf="revInfo.screeningMode == 'Priority'" class="row my-1 mx-0 border-top" [ngClass]="{'DisabledStep' : !CanWrite()}">
                <div class="col-7">
                    <ng-container *ngTemplateOutlet="TemplateTrainingCriteriaList"></ng-container>
                    <div class="col-12 font-weight-bold text-danger">Confirm: <input type="text" maxlength="30" [(ngModel)]="ConfirmTrainingListIsGood" /> </div>
                </div>
                <div class="col-5 rounded border border-info alert-info small">
                    This is the list used by the machine to <strong>learn</strong> from your choices.<br />
                    As the machine only evaluates titles and abstracts, you <strong>should not</strong> include codes that rely on <strong>data that does not appear in titles and abstract</strong>.
                    A typical type of codes that shouldn't appear below is <strong>"Exclude on Date"</strong>.<br />
                    This list is <strong>already saved</strong> and changes made here are <strong>saved immediately</strong>!<br />
                    To proceed, you need to type "I've checked" in the "<em class="text-danger">Confirm</em>" box.
                    This is because it is <strong>extremely important</strong> that the list of codes used to train the machine does not include codes that might confuse the machine.
                </div>
            </div>


            <div class="row my-1 mx-0 " [ngClass]="{'DisabledStep' : !CanChangePeoplePerItem}">
                <div class="col-7">
                    <ng-container *ngTemplateOutlet="TemplatePeoplePerItem"></ng-container>
                </div>
                <div class="col-5 rounded border border-info alert-info small">
                    How many people should screen each item? This is always <strong>one</strong> if the screening tool is in "Normal data entry" mode. <br />
                    Otherwise, for <em>double/multiple screening</em> it should be at least <strong>two</strong>, and can be risen to up to the number of review members.<br />
                    Please note that rising this number to more than three is <strong>not recommended</strong> (would make reconciliations very time consuming).
                </div>
            </div>
            <div class="row justify-content-center mx-0">
                <button (click)="PreviousStep()" class=" pt-1 m-1 btn btn-outline-dark " style="min-width:100px">
                    Previous
                </button>
                <button class=" pt-1 m-1 btn btn-success" style="min-width:100px" [disabled]="!CanGoToStep3()" (click)="NextStep()">
                    Next
                </button>
                <button class=" pt-1 m-1 btn btn-outline-dark " (click)="Cancel()" style="min-width:100px">
                    Cancel
                </button>
            </div>
        </div>


        <div *ngIf="CurrentStep==3" class="col-12 p-1 m-0 rounded border container border-info">
            <div class="row my-1 mx-0 ">
                <div class="col-8">
                    <ng-container *ngTemplateOutlet="TemplateReconciliationMode"></ng-container>
                </div>
                <div class="col-4 rounded border border-info alert-info small">
                    Optional policy to automatically complete some of the coding added to the chosen screening tool.
                    <strong>Things to note:</strong><br />
                    <ul class="mb-1 pl-1">
                        <li>This applies to all codes added from the screening tool, regardless of how it's done.</li>
                        <li>Automatically completed items will not participate in comparisons, making it <strong>harder to measure inter-rater agreements</strong>.</li>
                        <li>This setting has no effect if the screening tool is in "Normal" data entry mode.</li>
                    </ul>
                </div>
            </div>
            <div class="row my-1 mx-0 " [ngClass]="{'DisabledStep' : !CanChangeAutoExcludeAndIndexing}">
                <div class="col-8">
                    <ng-container *ngTemplateOutlet="TemplateAutoExclude"></ng-container>
                </div>
                
                <div class="col-4 rounded border border-info alert-info small">
                    The "Auto Exclude" option means that the Exclude (E) flag will be automatically assigned to items when an Exclude code is assigned and (automatically) completed.<br /> 
                    <strong>Important:</strong> the auto exclusion <strong>does not happen</strong> when manually completing some coding (either on a per item basis or via reconciliations).
                    
                </div>
            </div>
            <div class="row my-1 mx-0 " [ngClass]="{'DisabledStep' : !CanChangeAutoExcludeAndIndexing}">
                <div class="col-8">
                    <ng-container *ngTemplateOutlet="TemplateIndexing"></ng-container>
                </div>
                <div class="col-4 rounded border border-info alert-info small" style="max-height:150px; overflow-y:auto">
                    Active Learning relies on an <em>Index</em> of all words contained in the titles and abstracts. 
                    When this index is not up to date, the machine will produce sub-optimal results.<br />
                    EPPI-Reviewer keeps track of whether it's necessary to (re)build the index, 
                    but you can manually force the indexing to happen (once) via this setting. 
                    If you are setting up screening for the first time, please ensure that the indexing will happen (default).
                </div>
            </div>
            <div class="row justify-content-center mx-0">
                <div class="col-8 row align-content-end justify-content-center mx-0">
                    <div>
                        <button (click)="PreviousStep()" class=" pt-1 m-1 rounded btn btn-outline-dark " style="min-width:100px">
                            Previous
                        </button>
                        <button class=" pt-1 m-1 rounded  btn btn-outline-success" style="min-width:90px"
                                [disabled]="!CanSaveConfiguration" (click)="SaveOptionsAndGoToStep4()">
                            Save settings
                        </button>
                        <button class=" pt-1 m-1 rounded  btn btn-success" style="min-width:120px"
                                [disabled]="!CanSaveConfiguration" (click)="SaveOptionsAndCreateList()">
                            Save and Create List
                        </button>
                        <button class=" pt-1 m-1 rounded btn btn-outline-dark" (click)="Cancel()" style="min-width:100px">
                            Cancel
                        </button>
                    </div>
                </div>
                <div class="col-4 rounded border border-info alert-info small" style="max-height:150px; overflow-y:auto">
                    In order to begin screening, a screening list needs to be present and up-to-date. Thus, in most cases you'll want to click on "Save and Create List", which will also close this panel.<br />
                    Clicking "Save settings" will bring you to a summary page, where you can click "Create list" if needed and/or edit all settings.
                </div>
            </div>
        </div>
    </div>


    <!--All config and summary-->
    <div *ngIf="CurrentStep == 4" class="row m-1 p-1">
        <div class="col-md-12 col-lg-7 col-xl-6 p-1">
            <div class="border border-primary rounded m-0 p-1">
                <div class="row m-0 p-0 ">
                    <button class=" pt-1 m-1 rounded btn btn-outline-dark" (click)="Cancel()" style="min-width:100px">
                        Close
                    </button>
                    <div *ngIf="HasAdminRights" class="col">

                        <div class="brightSwitch row float-right">
                            <div class="mt-1 mr-1">Edit all Settings?</div>
                            <kendo-switch name="CanEditSW" class=""
                                          [disabled]="!CanWrite() "
                                          [(ngModel)]="AllowEditOnStep4"
                                          [onLabel]="'Yes'" (click)="CheckIfCancelEditAllOptions()"
                                          [offLabel]="'No'"></kendo-switch>
                        </div>
                    </div>
                </div>
                <div class="col-12 border border-primary rounded my-1 p-0">
                    <div class="row m-2 p-1 alert-info rounded">
                        <div class="col-12 p-0 m-0 rounded alert-light">
                            <button class="m-1 py-0 px-1 btn btn-outline-primary" [disabled]="!CanWrite() || !revInfo.screeningListIsGood" (click)="StartScreening()">
                                Begin Screening
                            </button>
                            <button class="m-1 py-0 px-1 btn btn-outline-secondary" [disabled]="!CanWrite()" (click)="GenerateList()">
                                (Re)Generate List
                            </button>
                            <button *ngIf="!IsServiceBusy()" class="btn btn-sm btn-outline-success mx-1 my-1 py-1 px-2 ng-star-inserted" (click)="RefreshAll()">
                              <fa-icon [icon]="faArrowsRotate" class="my-0"></fa-icon>
                            </button>

                        </div>
                        <div class="col-12 row p-0 mx-0 my-1 ">
                            <div class="d-block rounded alert-light border-light m-1 px-1">Review is indexed: <strong>{{revInfo.screeningIndexed ? "Yes" : "No"}}</strong></div>
                            <div class="d-block rounded alert-light border-light m-1 px-1">Screening List is present: <strong>{{revInfo.screeningListIsGood ? "Yes" : "No"}}</strong></div>
                            <div class="d-block rounded alert-light border-light m-1 px-1">Training is running: <strong>{{revInfo.screeningModelRunning ? "Yes" : "No"}}</strong></div>
                        </div>
                        <div *ngIf="!AllowEditOnStep4" class="col-12 row p-0 mx-0 my-1 ">
                            <div class="d-block rounded alert-light border-light  m-1 px-1">Screening tool: <strong>{{GetCodingToolName()}}</strong></div>
                            <div class="d-block rounded alert-light border-light  m-1 px-1">Screening mode: <strong>{{revInfo.screeningMode}}</strong></div>
                            <div *ngIf="revInfo.screeningWhatAttributeId > 0" class="d-block rounded alert-light border-light  m-1 px-1">
                                Screen items with this code:
                                <strong *ngIf="ItemsWithThisAttribute == null" class="alert-danger">Not Set</strong>
                                <strong *ngIf="ItemsWithThisAttribute !== null">{{ItemsWithThisAttribute.attribute_name}}</strong>
                            </div>
                            <div *ngIf="revInfo.screeningWhatAttributeId <= 0" class="d-block rounded alert-light  border-light m-1 px-1">
                                Screening <strong>all</strong> items.
                            </div>

                            <div *ngIf="revInfo.screeningNPeople > 1" class="d-block rounded alert-light border-light  m-1 px-1">
                                Reconciliation mode: <strong>{{SelectedReconcileOptionName}}</strong>
                            </div>
                            <div *ngIf="revInfo.screeningNPeople > 1" class="d-block rounded alert-light border-light m-1  px-1">
                                N of people screening each item: <strong>{{revInfo.screeningNPeople}}</strong>
                            </div>

                            <div *ngIf="revInfo.screeningNPeople <= 1" class="d-block rounded alert-light border-light  m-1 px-1">
                                N of people screening each item: <strong>1</strong>
                            </div>
                            
                        </div>
                        <div *ngIf="AllowEditOnStep4" class="col-12 p-1 mx-0 my-1 text-body rounded background bg-white">
                            <div class="row justify-content-center">
                                <div class="font-weight-bold text-primary">
                                    Edit all Screening Settings:
                                </div>
                            </div>

                            <ng-container *ngTemplateOutlet="TemplateScreeningTool"></ng-container>

                            <ng-container *ngTemplateOutlet="TemplateScreenWhat"></ng-container>

                            <ng-container *ngTemplateOutlet="TemplateScreeeningMode"></ng-container>

                            <ng-container *ngTemplateOutlet="TemplatePeoplePerItem"></ng-container>

                            <ng-container *ngTemplateOutlet="TemplateReconciliationMode"></ng-container>

                            <ng-container *ngTemplateOutlet="TemplateAutoExclude"></ng-container>

                            <ng-container *ngTemplateOutlet="TemplateIndexing"></ng-container>

                            <div class="row m-0 p-0">
                                <div class="m-2 p-1 rounded border border-info">
                                    <button class="m-1 py-1 px-1 btn btn-danger" [disabled]="!CanSaveConfiguration" (click)="SaveOptions()">
                                        Save
                                    </button>
                                    <button class="m-1 py-1 px-1 btn btn-outline-danger" [disabled]="!CanSaveConfiguration" (click)="SaveOptionsAndCreateList()">
                                        Save and (Re)Generate List
                                    </button>
                                    <button class="m-1 py-1 px-5 btn btn-outline-dark  " (click)="CancelEditingAllOptions()">
                                        Cancel
                                    </button>
                                    <div *ngIf="!ConfigHasChanged" class="row m-0 small"><div class=" rounded p-1 alert-info small">No change to save</div></div>
                                </div>
                            </div>
                        </div>
                    </div>


                </div>
                <div *ngIf="revInfo.screeningMode == 'Priority'" class="col-12 border border-primary rounded m-0 p-0">
                    <ng-container *ngTemplateOutlet="TemplateTrainingCriteriaList"></ng-container>
                </div>
            </div>
        </div>
        <div class="col-md-12 col-lg-5 col-xl-6 p-1">
            <div class="border border-primary rounded m-0 p-1">
                <div class="col-12 border border-primary rounded my-1 p-1">
                    <kendo-chart [title]="{ text: 'Screening progress' }">
                        <kendo-chart-series>
                            <kendo-chart-series-item type="scatterLine"
                                                     [data]="TrainingList"
                                                     xField="totalN" yField="totalIncludes">
                            </kendo-chart-series-item>
                        </kendo-chart-series>
                        <kendo-chart-x-axis>
                            <kendo-chart-x-axis-item [title]="{ text: 'Total Items' }"
                                                     [labels]="{ format: '{0}' }">
                            </kendo-chart-x-axis-item>
                        </kendo-chart-x-axis>
                        <kendo-chart-y-axis>
                            <kendo-chart-y-axis-item [title]="{ text: 'Included' }"
                                                     [labels]="{ format: '{0}' }">
                            </kendo-chart-y-axis-item>
                        </kendo-chart-y-axis>
                        <kendo-chart-tooltip format="{1} included, of {0} screened" class="small">
                        </kendo-chart-tooltip>
                    </kendo-chart>
                </div>
                <div class="col-12 border border-primary rounded m-0 p-0">
                    <div class="row m-0 p-0 ">
                        <div class="col m-0 p-0">
                            <button class="btn btn-outline-primary btn-sm px-1 py-0 m-1 float-right"
                                    (click)="ShowTrainingTable = !ShowTrainingTable">
                                {{ShowTrainingTableText}}
                            </button>
                        </div>
                    </div>
                    <div *ngIf="ShowTrainingTable" class="row mx-0 my-1 p-0 ">
                        <kendo-grid [data]="TrainingListData"
                                    [pageSize]="TrainingList.length"
                                    scrollable="virtual"
                                    [height]="300">
                            <kendo-grid-column field="iteration" [width]="1" title="#"
                                               headerClass="p-1 m-0 font-weight-bold small"
                                               class="p-1 m-0 small"></kendo-grid-column>
                            <kendo-grid-column field="endTime" title="Date" [width]="3"
                                               headerClass="p-1 m-0 font-weight-bold small"
                                               class="p-1 m-0 small">
                                <ng-template kendoGridCellTemplate let-dataItem>
                                    {{FormatDate(dataItem.endTime)}}
                                </ng-template>
                            </kendo-grid-column>
                            <kendo-grid-column field="contactName" title="By" [width]="3"
                                               headerClass="p-1 m-0 font-weight-bold small"
                                               class="p-1 m-0 small"></kendo-grid-column>
                            <kendo-grid-column field="totalIncludes" title="Included" [width]="2"
                                               headerClass="p-1 m-0 font-weight-bold small"
                                               class="p-1 m-0 small"></kendo-grid-column>
                            <kendo-grid-column field="totalExcludes" title="Excluded" [width]="2"
                                               headerClass="p-1 m-0 font-weight-bold small"
                                               class="p-1 m-0 small"></kendo-grid-column>
                            <kendo-grid-column field="totalN" title="Total" [width]="2"
                                               headerClass="p-1 m-0 font-weight-bold small"
                                               class="p-1 m-0 small"></kendo-grid-column>
                        </kendo-grid>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <ng-template #TemplateScreeningTool>
        <div class="row m-0 p-0">
            <div class="col-4 p-0 mt-2">
                <span *ngIf="CurrentStep==1">1.1 </span>Screeening Tool:
            </div>
            <div class="d-block my-1 col-8 p-0">
                <div ngbDropdown class="" style="min-width:200px;">
                    <button class="btn btn-outline-secondary dropdown-toggle"
                            style="min-width: 200px; max-width:720px;"
                            (click)="isCollapsedAllocateOptions = false;"
                            id="dropdownBasicCodingTool" ngbDropdownToggle>
                        {{GetCodingToolName()}}
                    </button>
                    <div ngbDropdownMenu aria-labelledby="dropdownBasicCodingTool" class="FlatDropdown">
                        <button (click)="setCodeSetDropDown(item)"
                                *ngFor="let item of ScreeningTools;" class="dropdown-item">
                            {{item.name}}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </ng-template>
    
    <ng-template #TemplateScreenWhat>
        <div class="row border-top border-info m-0 p-0">
            <div class="col-3 p-0 mt-1">
                <span *ngIf="CurrentStep==1">1.2 </span>What to screen:
            </div>
            <div class="col-9 p-0 mx-0 row">
                <div class=" d-block rounded border border-info my-1 mr-1 p-0">
                    <input class="mt-1 mx-1 d-inline" type="radio" [disabled]="!CanChangeWhatToScreen" name="whatToScreen"
                           [value]="true" (click)="ChangeWhatToScreen()" [(ngModel)]="ScreenAllItems">
                    <div class="mr-2 d-inline">All Items</div>
                </div>
                <div class=" d-block rounded border border-info p-0 m-1">
                    <input class="mt-1 mx-1 d-inline" type="radio" [disabled]="!CanChangeWhatToScreen" name="whatToScreen"
                           [value]="false" (click)="ChangeWhatToScreen()" [(ngModel)]="ScreenAllItems">
                    <div class="mr-2 d-inline">Items with this code:</div>
                </div>
            </div>
        </div>
        <div *ngIf="!ScreenAllItems" class="row m-0 p-0">
            <div class="col-3 p-0 mt-2">Pick the code:</div>
            <div class="d-block my-1 col-9 p-0">
                <div ngbDropdown class="">
                    <button ngbDropdownAnchor class="btn btn-outline-secondary dropdown-toggle"
                            id="dropdownTreeRandomAllocate"
                            style="min-width: 200px; max-width:720px;"
                            (click)="isCollapsedAllocateOptions = !isCollapsedAllocateOptions;"
                            [attr.aria-expanded]="!isCollapsedAllocateOptions" aria-controls="collapseCodeTreeWithWithout">
                        {{DropdownWithWithoutSelectedCode?.name}}
                    </button>
                    <div ngbDropdownMenu class="dropdown-menu" id="collapseCodeTreeWithWithout" [ngbCollapse]="!isCollapsedAllocateOptions">
                        <codesetSelector [IsMultiSelect]="false"
                                         [WhatIsSelectable]="'SetAttribute'" [MaxHeight]="500" #WithOrWithoutCode
                                         (selectedNodeInTree)="CloseCodeDropDownCodeWithWithout()"></codesetSelector>
                    </div>
                </div>
            </div>
        </div>
    </ng-template>

    <ng-template #TemplateScreeeningMode>
        <div class="row m-0 p-0 border-info border-top">
            <div class="col-4 p-0 mt-2">
                <span *ngIf="CurrentStep==2">2.1 </span>Screening Mode:
            </div>
            <div class="d-block my-1 col-8 p-0">
                <select class="rounded btn border border-info dropdonw-toggle" name="ScreeningModeOptionsSelect"
                        style="min-width: 200px; max-width:720px;" (change)="SetScreeningMode($event)">
                    <option *ngFor="let item of ScreeningModeOptions" [value]="item.value"
                            [selected]="item.value == revInfo.screeningMode">
                        {{item.value}}
                    </option>
                </select>
            </div>
        </div>
    </ng-template>

    <ng-template #TemplateTrainingCriteriaList>
        <div class="row p-0 m-0">
            <div *ngIf="CurrentStep !== 2" class="col-12 row justify-content-center m-0 p-0">
                <div class="font-weight-bold text-primary">
                    Training codes:
                </div>
            </div>
            <div *ngIf="CurrentStep == 2" class="col-12 row m-0 p-0">
                Training codes:
            </div>
            <div *ngIf="CurrentStep !== 2" class="alert-info rounded border border-info p-2 m-1 small">
                This is the list used by the machine to <strong>learn</strong> from your choiches.<br />
                As the machine only evaluates titles and abstracts, you <strong>should not</strong> include codes that rely on <strong>data that does not appear in titles and abstract</strong>.
                A typical type of codes that shouldn't appear below is <strong>"Exclude on Date"</strong>.<br />
                This list is <strong>already saved</strong> and changes made here are <strong>saved immediately</strong>! <br />
            </div>
        </div>
        <div *ngIf="AllowEditOnStep4 || CurrentStep==2" class="row p-0 m-0 rounded border border-info">
            <div class="col-12 px-1">
                <button *ngIf="!ShowAddTrainingCriteria" class="m-1 py-1 px-1 btn btn-outline-success" [disabled]="!CanWrite()" (click)="DoResetTrainingCodes()">
                    Repopulate...
                </button>
                <button *ngIf="!ShowAddTrainingCriteria" class="m-1 py-1 px-1 btn btn-outline-primary" [disabled]="!CanWrite()" (click)="ShowAddTrainingCriteriaClick()">
                    Add a code...
                </button>
                <button *ngIf="ShowAddTrainingCriteria" class="m-1 py-1 px-1 btn btn-outline-dark" (click)="ShowAddTrainingCriteriaClick()">
                    Cancel
                </button>
            </div>
            <div *ngIf="ShowAddTrainingCriteria" class="col-12 px-1">
                <div class="row p-0 m-0 ">
                    <div class="col-3 p-0 mt-2">Pick the code:</div>
                    <div class="d-block my-1 col-9 p-0">
                        <div ngbDropdown class="">
                            <button ngbDropdownAnchor class="btn btn-outline-secondary dropdown-toggle"
                                    id="dropdownTreeAddTrainingCriteria"
                                    style="min-width: 200px; max-width:720px;"
                                    (click)="isCollapsedDropdownAddTrainingCriteria = !isCollapsedDropdownAddTrainingCriteria;"
                                    [attr.aria-expanded]="!isCollapsedAllocateOptions" aria-controls="collapseCodeTreeWithWithout">
                                {{DropdownAddTrainingCriteriaSelectedCode?.name}}
                            </button>
                            <div ngbDropdownMenu class="dropdown-menu" id="collapseCodeTreeWithWithout" [ngbCollapse]="!isCollapsedDropdownAddTrainingCriteria">
                                <codesetSelector [IsMultiSelect]="false"
                                                 [WhatIsSelectable]="'ScreeningCodes'" [MaxHeight]="500" #AddTrainingCriteriaDDown
                                                 (selectedNodeInTree)="CloseCodeDropDownAddTrainingCriteria()"></codesetSelector>
                            </div>
                        </div>
                    </div>
                </div>
                <div *ngIf="DropdownAddTrainingCriteriaSelectedCode != null" class="row p-0 m-0 ">
                    <div class="col-3 p-0 mt-2">Details:</div>
                    <div class="d-block my-1 col-9 p-0">
                        <div class="m-2 small alert-info">
                            You'll add the code "<strong>{{DropdownAddTrainingCriteriaSelectedCode.name}}</strong>" and will be treated as an "<strong>{{TrainingCriteriaAddingCodeType}}</strong>" decision.
                        </div>
                        <button class="m-1 py-1 px-1 btn btn-outline-primary btn-sm" [disabled]="!CanWrite()" (click)="AddTrainingCriteriaDoItClick()">
                            Add!
                        </button>
                        <button *ngIf="ShowAddTrainingCriteria" class="m-1 py-1 px-2 btn btn-sm btn-outline-dark" (click)="ShowAddTrainingCriteriaClick()">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div style="max-height:300px;overflow:auto;">
            <table class="table table-striped table-sm">
                <tr>
                    <th class="px-0 pt-1 ml-1">
                        Code name
                    </th>
                    <th class="px-0 pt-1 ml-1">
                        Include/Exclude
                    </th>
                    <th *ngIf="AllowEditOnStep4 || CurrentStep==2" class="px-0 pt-1 ml-1">
                        Delete
                    </th>
                </tr>
                <tr *ngFor="let item of TrainingScreeningCriteriaList">
                    <td class="px-0 pt-1 ml-1">
                        {{item.attributeName}}
                    </td>
                    <td class="row p-0 m-0">
                        <div class="rounded border px-1 py-0 m-1"
                             [ngClass]="{'alert-success border-success': item.included, 'alert-danger border-danger' : !item.included}">
                            {{item.included ? 'Include' : 'Exclude'}}
                        </div>
                        <button *ngIf="AllowEditOnStep4 || CurrentStep==2" class="m-1 py-0 px-1 btn btn-sm btn-outline-primary" [disabled]="!CanWrite()"
                                (click)="FlipTrainingScreeningCriteria(item)">
                            Change
                        </button>
                    </td>
                    <td *ngIf="AllowEditOnStep4 || CurrentStep==2" class="px-0 pt-1">
                        <button class="m-1 py-0 px-1 btn btn-sm btn-outline-danger " [disabled]="!CanWrite()"
                                (click)="DeleteTrainingScreeningCriteria(item)">
                            Delete
                        </button>
                    </td>
                </tr>
            </table>
        </div>
        <div *ngIf="TrainingScreeningCriteriaListIsNotGoodMsg !=''" class="row p-0 m-0">
            <div class="m-1 p-1 alert-danger border border-danger rounded small" [innerHTML]="TrainingScreeningCriteriaListIsNotGoodMsg"></div>
        </div>
    </ng-template>

    <ng-template #TemplatePeoplePerItem>
        <div class="row m-0 p-0 border-info border-top">
            <div class="col-4 p-0 mt-2">
                <span *ngIf="CurrentStep==2">2.2 </span>N. of people per item:
            </div>
            <div *ngIf="selectedCodeSetDropDown && !selectedCodeSetDropDown.codingIsFinal" class="col-8 p-0 mx-0 row">
                <kendo-numerictextbox [(ngModel)]="revInfo.screeningNPeople"
                                      [disabled]="!CanChangePeoplePerItem || !CanWrite()"
                                      [min]="1" [format]="'n0'"
                                      [max]="Contacts.length > 10 ? 10 : Contacts.length"
                                      [step]="1"
                                      [autoCorrect]="true"
                                      (valueChange)="{}"
                                      class="border border-dark rounded mb-1"
                                      style="width: 100px;">
                </kendo-numerictextbox>
            </div>
            <div *ngIf="selectedCodeSetDropDown !=null && selectedCodeSetDropDown.codingIsFinal" class="col-8 p-0 mt-1 mx-0 row ">
                <div class="rounded alert-info small m-1 p-1"><strong>One</strong> (Screening set is in "Normal" data entry mode).</div>
                <div *ngIf="CanEditSelectedSet && !ShowChangeDataEntry" class="rounded alert-light small mx-1 my-0 p-0">
                    Click
                    <button class="btn btn-outline-danger btn-sm ml-1 px-1 py-0 mb-1" type="button" *ngIf="!ShowChangeDataEntry"
                            [disabled]="!CanChangePeoplePerItem || !CanEditSelectedSet"
                            (click)="ShowChangeDataEntryClicked()">
                        here
                    </button>
                    to enable changing its data entry mode.
                </div>
            </div>
            <div *ngIf="!selectedCodeSetDropDown == null" class="col-8 p-0 mt-1 mx-0 row">
                <div class="rounded alert-danger small m-1 p-1">Please select the screening tool first..</div>
            </div>
        </div>
        <div *ngIf="!CheckAndUpdatePeoplePerItem() || ShowChangeDataEntry" class="row m-0 p-0">
            <div *ngIf="revInfo.screeningCodeSetId >= 1 && (selectedCodeSetDropDown && selectedCodeSetDropDown.codingIsFinal && revInfo.screeningNPeople != 1)"
                 class="alert-danger rounded row col-12 m-1">
                <div class="col-12 m-0 p-0">
                    <div>
                        The selected screening tool is set for single coding (Normal Data Entry).<br />
                        Do you wish to change the data entry mode to Comparison Coding?
                    </div>
                    <div class="alert-light border border-danger rounded col-12 small">
                        <div class="mt-1">Change to Data Entry Mode: {{WorkToDoSelectedCodeSetDataEntryM}}</div>
                        <button class="btn btn-outline-danger btn-sm ml-1 mb-1" type="button" *ngIf="!ShowChangeDataEntry"
                                [disabled]="!CanChangePeoplePerItem || !CanEditSelectedSet"
                                (click)="ShowChangeDataEntryClicked()">
                            Change
                        </button>
                        <div *ngIf="ShowChangeDataEntry" class="alert alert-danger">
                            <div>{{ChangeDataEntryModeMessage}}</div>
                            <button class="btn btn-outline-secondary btn-sm mb-1" (click)="HideChangeDataEntry()" type="button">Cancel</button>
                            <div *ngIf="CanChangeDataEntryMode" class="alert alert-light">
                                Yes, change to
                                <button class="btn btn-outline-danger btn-sm ml-1 mr-1" type="button"
                                        [disabled]="!CanChangePeoplePerItem || !CanEditSelectedSet" (click)="DoChangeDataEntry()">
                                    {{DestinationDataEntryMode}}
                                </button>
                                mode.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div *ngIf="revInfo.screeningCodeSetId >= 1 && (selectedCodeSetDropDown && !selectedCodeSetDropDown.codingIsFinal && revInfo.screeningNPeople > 1)"
                 class="alert-success  rounded row col-12 m-1">
                The selected coding tool is set for multiple coding (Comparison Data Entry): more than one person per item is appropriate.
            </div>
            <div *ngIf="revInfo.screeningCodeSetId >= 1 && (selectedCodeSetDropDown && !selectedCodeSetDropDown.codingIsFinal && revInfo.screeningNPeople == 1)"
                 class="alert-danger  rounded row col-12 m-1">
                <div>
                    The selected coding tool is set for multiple coding (Comparison Data Entry).<br />
                    Do you wish to change the data entry mode to Normal coding?
                </div>
                <div class="alert-light border border-danger rounded col-12 small">
                    <div class="mt-1">Change to Data Entry Mode: {{WorkToDoSelectedCodeSetDataEntryM}}</div>
                    <button class="btn btn-outline-danger btn-sm ml-1 mb-1" type="button" *ngIf="!ShowChangeDataEntry"
                            [disabled]="!CanChangePeoplePerItem || !CanEditSelectedSet"
                            (click)="ShowChangeDataEntryClicked()">
                        Change
                    </button>
                    <div *ngIf="ShowChangeDataEntry" class="alert alert-danger">
                        <div>{{ChangeDataEntryModeMessage}}</div>
                        <button class="btn btn-outline-secondary btn-sm mb-1" (click)="HideChangeDataEntry()" type="button">Cancel</button>
                        <div *ngIf="CanChangeDataEntryMode" class="alert alert-light">
                            Yes, change to
                            <button class="btn btn-outline-danger btn-sm ml-1 mr-1" type="button"
                                    [disabled]="!CanChangePeoplePerItem || !CanWrite()" (click)="DoChangeDataEntry()">
                                {{DestinationDataEntryMode}}
                            </button>
                            mode.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </ng-template>
    
    <ng-template #TemplateReconciliationMode>
        <div class="row border-top border-info m-0 p-0">
            <div class="col-4 p-0 mt-2">
                <span *ngIf="CurrentStep==3">3.1 </span>Reconciliation Mode:
            </div>
            <div *ngIf="selectedCodeSetDropDown && selectedCodeSetDropDown.codingIsFinal" class="d-block my-1 col-8 p-0">
                <div class="rounded small alert-info m-1 p-1">Set is in Normal Data entry mode: coding will be completed immediately.</div>
            </div>
            <div *ngIf="selectedCodeSetDropDown && !selectedCodeSetDropDown.codingIsFinal" class="d-block mb-1 mt-0 col-12 p-0">
                <select class="rounded small btn border border-info dropdonw-toggle" name="ScreeningModeOptionsSelect"
                        style="min-width: 200px; max-width:720px;" (change)="SetReconciliationMode($event)">
                    <option *ngFor="let item of ReconcileOptions" [value]="item.key" class="small"
                            [selected]="item.key == revInfo.screeningReconcilliation">
                        {{item.value}}
                    </option>
                </select>
            </div>
            <div *ngIf="selectedCodeSetDropDown == null" class="d-block my-1 col-8 p-0">
                <div class="rounded small alert-danger m-1 p-1">Please select a coding tool.</div>
            </div>
        </div>
        <div *ngIf="ReconciliationModeError != ''" class="row m-0 p-0">
            <div class="rounded small alert-danger m-1 p-1 ">{{ReconciliationModeError}}</div>
        </div>
        <div *ngIf="ReconciliationModeError == '' && ReconciliationModeSummary != ''" class="row m-0 p-0">
            <div class="rounded small alert-info m-1 p-1" [innerHTML]="ReconciliationModeSummary"></div>
        </div>
    </ng-template>
    
    <ng-template #TemplateAutoExclude>
        <div class="row border-top border-info m-0 p-0">
            <div class="col-4 p-0 mt-1">
                <span *ngIf="CurrentStep==3">3.2 </span>Auto Exclude?
            </div>
            <div class="col-8 p-0 mx-0 row">
                <div class=" d-block rounded border border-info my-1 mr-1 p-0">
                    <input class="mt-1 mx-1 d-inline" type="radio" [disabled]="!CanChangeAutoExcludeAndIndexing || !CanWrite()" name="AutoExclude"
                           [value]="true" [(ngModel)]="revInfo.screeningAutoExclude">
                    <div class="mr-2 d-inline">Yes</div>
                </div>
                <div class=" d-block rounded border border-info p-0 m-1">
                    <input class="mt-1 mx-1 d-inline" type="radio" [disabled]="!CanChangeAutoExcludeAndIndexing || !CanWrite()" name="AutoExclude"
                           [value]="false" [(ngModel)]="revInfo.screeningAutoExclude">
                    <div class="mr-2 d-inline">No</div>
                </div>
            </div>
            <div *ngIf="revInfo.screeningAutoExclude" class="col-12 p-0 mx-0 mb-1 row">
                <div class="rounded alert-info m-0 p-1 small">
                    <div class="alert-warning m-1 p-1"><strong>Warning:</strong> this will mark items with the Exclude (E) flag <strong>only when</strong> their coding is automatically completed.</div>
                    When completing some coding via comparions, the items that received Exclude codes, <strong>will not</strong> receive the E flag.
                    You <strong>must remember</strong> to do so yourself (list all items with an exclude code, select them all, click on the "In/Exclude" button in the "References" tab).
                </div>
            </div>
        </div>
    </ng-template>
    
    <ng-template #TemplateIndexing>
        <div class="row border-top border-info m-0 p-0">
            <div class="col-4 p-0 mt-1">
                <span *ngIf="CurrentStep==3">3.3 </span>Indexing:
            </div>
            <div *ngIf="revInfo.screeningIndexed" class="col-12 p-0 mx-0 mb-1 row">
                <div class="rounded alert-info m-0 p-1 small">
                    The index is <strong>up to date</strong>. This means that the machine has received the full titles and abstracts of all the references to screen.<br />
                    As a result, the next training round will not rebuild the index (takes a little longer).<br />
                    To make the index rebuild at the next training, click
                    <button class="btn btn-outline-danger btn-sm ml-1 px-1 py-0 mb-1" type="button" *ngIf="!ShowChangeDataEntry"
                            [disabled]="!CanChangeAutoExcludeAndIndexing || !CanWrite()"
                            (click)="revInfo.screeningIndexed = !revInfo.screeningIndexed">
                        here
                    </button>.
                </div>
            </div>
            <div *ngIf="!revInfo.screeningIndexed" class="col-12 p-0 mx-0 mb-1 row">
                <div class="rounded alert-info m-0 p-1 small">
                    The index is <strong>not up to date</strong>. This means that at the next training round the machine will re-index the titles and abstracts to ensure
                    it will train against the most up to date data (training will take a little longer).<br />
                    If you believe that this is not necessary, click
                    <button class="btn btn-outline-danger btn-sm ml-1 px-1 py-0 mb-1" type="button" *ngIf="!ShowChangeDataEntry"
                            [disabled]="!CanChangeAutoExcludeAndIndexing || !CanWrite()"
                            (click)="revInfo.screeningIndexed = !revInfo.screeningIndexed">
                        here
                    </button>.
                </div>
            </div>
        </div>
    </ng-template>
</div>


